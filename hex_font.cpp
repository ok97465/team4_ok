#include "hex_font.h"
#include <cstring>
#ifdef _WIN32
#include <windows.h>
#endif

#define HEX_FONT_WIDTH_BYTES 3

const uint8_t HexFont24x24[HEX_FONT_GLYPHS][HEX_FONT_HEIGHT][HEX_FONT_WIDTH_BYTES] = {
    { // 0
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}
    },
    { // 1
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x01, 0xF0, 0x00}, {0x01, 0xF0, 0x00}, {0x01, 0xF0, 0x00},
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x01, 0xF8, 0x00}, {0x01, 0xF8, 0x00}, {0x01, 0xF8, 0x00}
    },
    { // 2
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00},
        {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00},
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00},
        {0x07, 0x00, 0x00}, {0x07, 0x00, 0x00}, {0x07, 0x00, 0x00},
        {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}
    },
    { // 3
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00},
        {0x01, 0xF8, 0x00}, {0x01, 0xF8, 0x00}, {0x01, 0xF8, 0x00},
        {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // 4
        {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00},
        {0x00, 0xE8, 0x00}, {0x00, 0xE8, 0x00}, {0x00, 0xE8, 0x00},
        {0x01, 0xC8, 0x00}, {0x01, 0xC8, 0x00}, {0x01, 0xC8, 0x00},
        {0x07, 0x1C, 0x00}, {0x07, 0x1C, 0x00}, {0x07, 0x1C, 0x00},
        {0x0F, 0x1C, 0x00}, {0x0F, 0x1C, 0x00}, {0x0F, 0x1C, 0x00},
        {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00},
        {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00},
        {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00}
    },
    { // 5
        {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00},
        {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // 6
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // 7
        {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00},
        {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00},
        {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00},
        {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00}, {0x00, 0x70, 0x00},
        {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00},
        {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00},
        {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00}, {0x01, 0xC0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // 8
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // 9
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xF8, 0x00}, {0x07, 0xF8, 0x00}, {0x07, 0xF8, 0x00},
        {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00}, {0x00, 0x07, 0x00},
        {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00}, {0x00, 0x1C, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // A
        {0x07, 0x70, 0x00}, {0x07, 0x70, 0x00}, {0x07, 0x70, 0x00},
        {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00},
        {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00},
        {0x0F, 0xF8, 0x00}, {0x0F, 0xF8, 0x00}, {0x0F, 0xF8, 0x00},
        {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00},
        {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00},
        {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // B
        {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0xE0, 0x00}, {0x0F, 0xE0, 0x00}, {0x0F, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // C
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00}, {0x07, 0xE0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // D
        {0x0F, 0xE0, 0x00}, {0x0F, 0xE0, 0x00}, {0x0F, 0xE0, 0x00},
        {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00}, {0x0F, 0x87, 0x00},
        {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00}, {0x0F, 0x9C, 0x00},
        {0x0F, 0xE0, 0x00}, {0x0F, 0xE0, 0x00}, {0x0F, 0xE0, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // E
        {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    },
    { // F
        {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00}, {0x0F, 0xFC, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00}, {0x0F, 0xF0, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00}, {0x0F, 0x00, 0x00},
        {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}, {0x00, 0x00, 0x00}
    }
};

bool BuildConsolasHexAtlas(unsigned char atlas[HEX_FONT_HEIGHT][HEX_FONT_WIDTH * HEX_FONT_GLYPHS])
{
#ifdef _WIN32
    HFONT font = CreateFontA(HEX_FONT_HEIGHT, 0, 0, 0, FW_NORMAL, FALSE, FALSE, FALSE,
                             ANSI_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS,
                             ANTIALIASED_QUALITY, FF_DONTCARE, "Consolas");
    if (!font)
        return false;

    HDC hdc = CreateCompatibleDC(NULL);
    BITMAPINFO bmi = {};
    bmi.bmiHeader.biSize = sizeof(BITMAPINFOHEADER);
    bmi.bmiHeader.biWidth = HEX_FONT_WIDTH * HEX_FONT_GLYPHS;
    bmi.bmiHeader.biHeight = HEX_FONT_HEIGHT;
    bmi.bmiHeader.biPlanes = 1;
    bmi.bmiHeader.biBitCount = 32;
    bmi.bmiHeader.biCompression = BI_RGB;

    unsigned char* bits = nullptr;
    HBITMAP dib = CreateDIBSection(hdc, &bmi, DIB_RGB_COLORS, (void**)&bits, NULL, 0);
    HGDIOBJ oldBmp = SelectObject(hdc, dib);
    HGDIOBJ oldFont = SelectObject(hdc, font);

    RECT rc = {0, 0, HEX_FONT_WIDTH * HEX_FONT_GLYPHS, HEX_FONT_HEIGHT};
    HBRUSH black = (HBRUSH)GetStockObject(BLACK_BRUSH);
    FillRect(hdc, &rc, black);
    SetBkMode(hdc, TRANSPARENT);
    SetTextColor(hdc, RGB(255,255,255));

    const char glyphs[HEX_FONT_GLYPHS] = "0123456789ABCDEF";
    for (int i = 0; i < HEX_FONT_GLYPHS; ++i)
    {
        TextOutA(hdc, i * HEX_FONT_WIDTH, 0, &glyphs[i], 1);
    }

    for (int y = 0; y < HEX_FONT_HEIGHT; ++y)
    {
        for (int x = 0; x < HEX_FONT_WIDTH * HEX_FONT_GLYPHS; ++x)
        {
            atlas[y][x] = bits[(HEX_FONT_HEIGHT - 1 - y) * (HEX_FONT_WIDTH * HEX_FONT_GLYPHS) * 4 + x * 4];
        }
    }

    SelectObject(hdc, oldFont);
    SelectObject(hdc, oldBmp);
    DeleteObject(dib);
    DeleteDC(hdc);
    DeleteObject(font);
    return true;
#else
    (void)atlas;
    return false;
#endif
}
